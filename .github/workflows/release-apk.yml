name: Release APK
permissions:
  contents: write  # æˆäºˆå†™å…¥ repo çš„æƒé™
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_name:
        description: 'Version name for the release'
        required: true
        default: '1.0.0'
      release_notes:
        description: 'Custom release notes (optional)'
        required: false
        default: ''
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Verify environment
      run: |
        echo "Java version:"
        java -version
        echo "Gradle version:"
        ./gradlew --version
        echo "Android SDK location: $ANDROID_HOME"
        
    - name: Create secrets.properties
      run: |
        # åªæ·»åŠ å·²é…ç½®çš„ secretsï¼Œæ²¡æœ‰é…ç½®çš„å°±è·³è¿‡
        touch secrets.properties
        
        # å¿…è¦çš„å˜é‡
        if [ -n "${{ secrets.DEEPSEEK_API_KEY }}" ]; then
          echo "DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}" >> secrets.properties
        fi
        
        if [ -n "${{ secrets.CUSTOM_PROVIDER_API_BASE_URL }}" ]; then
          echo "CUSTOM_PROVIDER_API_BASE_URL=${{ secrets.CUSTOM_PROVIDER_API_BASE_URL }}" >> secrets.properties
        fi
        
        if [ -n "${{ secrets.CUSTOM_PROVIDER_API_KEY }}" ]; then
          echo "CUSTOM_PROVIDER_API_KEY=${{ secrets.CUSTOM_PROVIDER_API_KEY }}" >> secrets.properties
        fi
        
        # å¯é€‰çš„å˜é‡
        if [ -n "${{ secrets.AZURE_API_KEY }}" ]; then
          echo "azureApiKey=${{ secrets.AZURE_API_KEY }}" >> secrets.properties
        fi
        
        if [ -n "${{ secrets.AZURE_REGION }}" ]; then
          echo "azureRegion=${{ secrets.AZURE_REGION }}" >> secrets.properties
        fi
        
        if [ -n "${{ secrets.TEST_AI_HUB_MIX_TOKEN }}" ]; then
          echo "testAiHubMixToken=${{ secrets.TEST_AI_HUB_MIX_TOKEN }}" >> secrets.properties
        fi
        
        echo "Created secrets.properties with available secrets"
        echo "secrets.properties content (without sensitive data):"
        grep -v "API_KEY\|TOKEN" secrets.properties || echo "No non-sensitive properties to show"
        
    - name: Generate keystore from base64
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        echo "=== ä»Base64ç”Ÿæˆkeystore.jks ==="
        
        if [ -z "$KEYSTORE_BASE64" ]; then
            echo "âŒ KEYSTORE_BASE64 ä¸ºç©º"
            exit 1
        else
            echo "âœ… KEYSTORE_BASE64 å­˜åœ¨"
        fi
        
        echo "è§£ç base64å¹¶ç”Ÿæˆkeystore.jks..."
        echo "$KEYSTORE_BASE64" | base64 -d > keystore.jks
        
        echo "éªŒè¯ç”Ÿæˆçš„keystoreæ–‡ä»¶..."
        if [ -f "keystore.jks" ]; then
            echo "âœ… keystore.jks æ–‡ä»¶å·²ç”Ÿæˆ"
            echo "æ–‡ä»¶å¤§å°: $(stat -c%s keystore.jks) bytes"
            echo "æ–‡ä»¶æƒé™: $(ls -la keystore.jks)"
        else
            echo "âŒ keystore.jks æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
        fi
        
        echo ""
        echo "2. æ£€æŸ¥ç­¾åç¯å¢ƒå˜é‡:"
        if [ -z "$KEYSTORE_PASSWORD" ]; then
            echo "âŒ KEYSTORE_PASSWORD ä¸ºç©º"
            exit 1
        else
            echo "âœ… KEYSTORE_PASSWORD å­˜åœ¨"
        fi
        
        if [ -z "$KEY_ALIAS" ]; then
            echo "âŒ KEY_ALIAS ä¸ºç©º"
            exit 1
        else
            echo "âœ… KEY_ALIAS å­˜åœ¨: $KEY_ALIAS"
        fi
        
        if [ -z "$KEY_PASSWORD" ]; then
            echo "âŒ KEY_PASSWORD ä¸ºç©º"
            exit 1
        else
            echo "âœ… KEY_PASSWORD å­˜åœ¨"
        fi
        
        echo ""
        echo "âœ… æ‰€æœ‰ç­¾åé…ç½®éªŒè¯é€šè¿‡"

    - name: Create signing config
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        echo "=== åˆ›å»ºç­¾åé…ç½® ==="
        
        # åˆ›å»ºkeystore.propertiesæ–‡ä»¶ï¼ˆæœ¬åœ°å¼€å‘ç”¨ï¼‰
        cat > keystore.properties << EOF
        storeFile=keystore.jks
        storePassword=${{ secrets.KEYSTORE_PASSWORD }}
        keyAlias=${{ secrets.KEY_ALIAS }}
        keyPassword=${{ secrets.KEY_PASSWORD }}
        EOF
        
        # è®¾ç½®Gradleå±æ€§ï¼ˆCI/CDç¯å¢ƒç”¨ï¼‰
        echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> gradle.properties
        echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> gradle.properties
        echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> gradle.properties
        
        echo "âœ… ç­¾åé…ç½®åˆ›å»ºå®Œæˆ"
        echo ""
        echo "keystore.properties content:"
        cat keystore.properties | sed 's/storePassword=.*/storePassword=*****/' | sed 's/keyPassword=.*/keyPassword=*****/'
        echo ""
        echo "gradle.properties content (signing part):"
        grep -E "(KEYSTORE_|KEY_)" gradle.properties | sed 's/=.*/=*****/' || echo "No signing properties found in gradle.properties"
        
    - name: Update version name
      if: ${{ github.event.inputs.version_name }}
      run: |
        sed -i 's/versionName = "[^"]*"/versionName = "${{ github.event.inputs.version_name }}"/' app/build.gradle.kts
        
    - name: Build Release APK
      run: |
        echo "Starting Gradle build..."
        ./gradlew assembleRelease --stacktrace --info
        
    - name: Verify APK and signing
      run: |
        echo "Checking build outputs..."
        ls -la app/build/outputs/apk/release/
        
        if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          echo "âœ… APK file found"
          
          # éªŒè¯APKç­¾å
          if command -v $ANDROID_HOME/build-tools/34.0.0/apksigner &> /dev/null; then
            echo "Verifying APK signature..."
            $ANDROID_HOME/build-tools/34.0.0/apksigner verify --print-certs app/build/outputs/apk/release/app-release.apk
            echo "âœ… APK signature verified"
          else
            echo "âš ï¸ apksigner not found, skipping signature verification"
          fi
          
          # æ˜¾ç¤ºAPKä¿¡æ¯
          APK_SIZE=$(stat -c%s app/build/outputs/apk/release/app-release.apk)
          echo "ğŸ“± APK size: $(($APK_SIZE / 1024 / 1024)) MB"
        else
          echo "âŒ APK file not found!"
          echo "Available files in release directory:"
          find app/build/outputs/apk/release/ -type f || echo "No files found"
          exit 1
        fi
          
    - name: Rename APK
      run: |
        VERSION_NAME=${{ github.event.inputs.version_name || github.ref_name }}
        mv app/build/outputs/apk/release/app-release.apk app/build/outputs/apk/release/AIGroupApp-${VERSION_NAME}.apk
        echo "âœ… APK renamed to AIGroupApp-${VERSION_NAME}.apk"

    - name: Create tag for manual release
      if: github.event_name == 'workflow_dispatch'
      run: |
        VERSION_NAME=${{ github.event.inputs.version_name }}
        echo "Creating tag for version: $VERSION_NAME"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        if git rev-parse "refs/tags/$VERSION_NAME" >/dev/null 2>&1; then
          echo "Tag $VERSION_NAME already exists, deleting it first"
          git tag -d "$VERSION_NAME" || true
          git push origin ":refs/tags/$VERSION_NAME" || true
        fi
        
        # åˆ›å»ºæ–°æ ‡ç­¾
        git tag -a "$VERSION_NAME" -m "Release $VERSION_NAME (manual trigger)"
        git push origin "$VERSION_NAME"
        echo "âœ… Tag $VERSION_NAME created and pushed"
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      with:
        tag_name: ${{ github.event.inputs.version_name || github.ref_name }}
        name: Release ${{ github.event.inputs.version_name || github.ref_name }}
        files: app/build/outputs/apk/release/AIGroupApp-*.apk
        generate_release_notes: true
        draft: false
        prerelease: ${{ github.event.inputs.prerelease == 'true' || false }}
        make_latest: ${{ github.event.inputs.prerelease != 'true' }}
        body: |
          ## ğŸš€ AIGroup Mobile App Release ${{ github.event.inputs.version_name || github.ref_name }}
          
          ### ğŸ“± ä¸‹è½½å®‰è£…åŒ…
          ç‚¹å‡»ä¸‹æ–¹é“¾æ¥ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„ AIGroup Mobile Appï¼š
          
          **[ğŸ“¥ ä¸‹è½½ AIGroupApp-${{ github.event.inputs.version_name || github.ref_name }}.apk](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version_name || github.ref_name }}/AIGroupApp-${{ github.event.inputs.version_name || github.ref_name }}.apk)**
          
          ### ğŸ”§ æ„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬å·**: `${{ github.event.inputs.version_name || github.ref_name }}`
          - **æ„å»ºID**: `${{ github.run_id }}`
          - **è§¦å‘æ–¹å¼**: ${{ github.event_name == 'workflow_dispatch' && 'ğŸ–±ï¸ æ‰‹åŠ¨è§¦å‘' || 'ğŸ·ï¸ æ ‡ç­¾æ¨é€' }}
          - **æäº¤SHA**: `${{ github.sha }}`
          - **æ„å»ºæ—¶é—´**: ${{ github.run_started_at }}
          - **å‘å¸ƒç±»å‹**: ${{ github.event.inputs.prerelease == 'true' && 'ğŸ§ª é¢„å‘å¸ƒç‰ˆæœ¬' || 'âœ… æ­£å¼ç‰ˆæœ¬' }}
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          ${{ github.event.inputs.release_notes || (github.event_name == 'workflow_dispatch' && 'æ­¤ç‰ˆæœ¬é€šè¿‡æ‰‹åŠ¨è§¦å‘æ„å»ºï¼Œè¯¦ç»†æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹ä¸‹æ–¹çš„è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜æˆ–æäº¤å†å²ã€‚' || '') }}
          
          ---
          
          ### ğŸ“– å®‰è£…è¯´æ˜
          1. ä¸‹è½½ä¸Šæ–¹çš„ APK æ–‡ä»¶
          2. åœ¨ Android è®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
          3. å®‰è£…ä¸‹è½½çš„ APK æ–‡ä»¶
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - è¯·ç¡®ä¿ä»å®˜æ–¹ GitHub Release é¡µé¢ä¸‹è½½
          - é¦–æ¬¡å®‰è£…å¯èƒ½éœ€è¦å…è®¸å®‰è£…æœªçŸ¥æ¥æºçš„åº”ç”¨
          - å»ºè®®åœ¨å®‰è£…å‰å¸è½½æ—§ç‰ˆæœ¬ä»¥é¿å…å†²çª
          ${{ github.event.inputs.prerelease == 'true' && '- âš ï¸ è¿™æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„åŠŸèƒ½' || '' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-apk-${{ github.event.inputs.version_name || github.ref_name }}
        path: app/build/outputs/apk/release/AIGroupApp-*.apk
        retention-days: 30
        
    - name: Release Summary
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      run: |
        VERSION_NAME=${{ github.event.inputs.version_name || github.ref_name }}
        RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${VERSION_NAME}"
        APK_SIZE=$(stat -c%s app/build/outputs/apk/release/AIGroupApp-${VERSION_NAME}.apk)
        APK_SIZE_MB=$(($APK_SIZE / 1024 / 1024))
        
        echo "## ğŸ‰ å‘å¸ƒæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ å‘å¸ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: \`${VERSION_NAME}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **APK å¤§å°**: ${APK_SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name == 'workflow_dispatch' && 'æ‰‹åŠ¨è§¦å‘' || 'æ ‡ç­¾æ¨é€' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å‘å¸ƒç±»å‹**: ${{ github.event.inputs.prerelease == 'true' && 'é¢„å‘å¸ƒç‰ˆæœ¬' || 'æ­£å¼ç‰ˆæœ¬' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— é“¾æ¥" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸ“¥ ä¸‹è½½ Release]($RELEASE_URL)" >> $GITHUB_STEP_SUMMARY
        echo "- [ğŸ“± ç›´æ¥ä¸‹è½½ APK](https://github.com/${{ github.repository }}/releases/download/${VERSION_NAME}/AIGroupApp-${VERSION_NAME}.apk)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… APK å·²æˆåŠŸæ„å»ºå¹¶å‘å¸ƒåˆ° GitHub Releaseï¼"